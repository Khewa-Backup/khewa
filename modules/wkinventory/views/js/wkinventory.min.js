/**
* NOTICE OF LICENSE
*
* This file is part of the 'WK Inventory' module feature.
* Developped by Khoufi Wissem (2017).
* You are not allowed to use it on several site
* You are not allowed to sell or redistribute this module
* This header must not be removed
*
*  @author    KHOUFI Wissem - K.W
*  @copyright Khoufi Wissem
*  @license   http://opensource.org/licenses/afl-3.0.php  Academic Free License (AFL 3.0)
*/
function beginUpdateProcess(t){return $("#done_on").is(":checked")?($(".div-location, .dialog-notice").fadeOut(500),processNow(0,5,-1,!0)):(form=$(t).closest("form"),form.submit()),!1}function processNow(t,e,o,s){0==t&&s&&updateProgressionInit(),0!=t||s||updateProgression(0,o,e,!1,null);var a=(new Date).getTime();$.ajax({type:"POST",url:url_global+"&offset="+t+"&limit="+e+(s?"&validateBefore=1":""),cache:!1,dataType:"json",data:{ajax:1,action:"closeInventory",done:1,name:$("#name").val(),id_inventory:$("#id").val()},success:function(i){var r,n,d,l,c,u,p;if(i.totalCount&&(o=i.totalCount),i.informations&&i.informations.length>0&&updateValidationInfo("<li>"+i.informations.join("</li><li>")+"</li>"),i.warnings&&i.warnings.length>0&&(s?updateValidationError("<li>"+i.warnings.join("</li><li>")+"</li>",!0):updateProgressionError("<li>"+i.warnings.join("</li><li>")+"</li>",!0)),i.errors&&i.errors.length>0)s?updateValidationError("<li>"+i.errors.join("</li><li>")+"</li>",!1):updateProgressionError("<li>"+i.errors.join("</li><li>")+"</li>",!1);else if(1==!i.isFinished){if(r=(new Date).getTime()-a,n=5e3,d=Math.min(4,n/r),l=Math.min(100,Math.max(5,Math.floor(e*d))),c=t+e,s?updateValidation(i.doneCount,o,i.doneCount+l):updateProgression(i.doneCount,o,i.doneCount+l,!1),1==importCancelRequest)return $("#importProgress").modal("hide"),importCancelRequest=!1,void(window.location.href=url_global);processNow(c,l,o,s),i.nextPostSize>=.9*i.postSizeLimit&&(u=100*i.doneCount/o,p=Math.max(7,parseInt(i.postSizeLimit/(1024*u*1024)))+1,$("#import_details_post_limit_value").html(p+" MB"),$("#import_details_post_limit").show())}else s?(updateValidation(o,o,o),$("#import_details_warning").is(":visible")?(importContinueRequest=!0,$("#import_continue_button").show()):($("#import_progress_div").show(),processNow(0,5,o,!1))):(updateProgression(o,o,o,!0),document.getElementById("alarmAudio").play())},error:function(t,e,o){"parsererror"==e&&(e="Technical error: Unexpected response returned by server. Process stopped. Check logs page!"),s?updateValidationError(e,!1):updateProgressionError(e,!1)}})}function updateProgressionInit(){$("#importProgress").modal({backdrop:"static",keyboard:!1,closable:!1}),$("#importProgress").modal("show"),$("#importProgress").on("hidden.bs.modal",function(){window.location.href=url_global}),$("#import_details_progressing").show(),$("#import_details_finished").hide(),$("#import_details_error").hide(),$("#import_details_warning, #import_details_info").hide(),$("#import_details_stop").hide(),$("#import_details_post_limit").hide(),$("#import_details_error ul").html(""),$("#import_details_warning ul, #import_details_info ul").html(""),$("#import_validation_details").html($("#import_validation_details").attr("default-value")),$("#validate_progressbar_done").width("0%"),$("#validate_progressbar_done").parent().addClass("active progress-striped"),$("#validate_progression_done").html("0"),$("#validate_progressbar_done2").width("0%"),$("#validate_progressbar_next").width("0%"),$("#validate_progressbar_next").removeClass("progress-bar-danger"),$("#validate_progressbar_next").addClass("progress-bar-info"),$("#import_progress_div").hide(),$("#import_progression_details").html($("#import_progression_details").attr("default-value")),$("#import_progressbar_done").width("0%"),$("#import_progressbar_done").parent().addClass("active progress-striped"),$("#import_progression_done").html("0"),$("#import_progressbar_next").width("0%"),$("#import_progressbar_next").removeClass("progress-bar-danger"),$("#import_progressbar_next").addClass("progress-bar-success"),$("#import_stop_button").show(),$("#import_close_button").hide(),$("#import_go_button").hide(),$("#import_continue_button").hide()}function updateValidation(t,e,o){var s,a;t>e&&(t=e),o>e&&(o=e),s=100*t/e,a=100*o/e,e>0&&($("#import_validate_div").show(),$("#import_validation_details").html(t+"/"+e),$("#validate_progressbar_done").width(s+"%"),$("#validate_progression_done").html(parseInt(s)),$("#validate_progressbar_next").width(a-s+"%")),t==e&&e==o&&$("#validate_progressbar_done").parent().removeClass("active progress-striped")}function updateProgression(t,e,o,s){var a;t>e&&(t=e),o>e&&(o=e),a=100*t/e,e>0&&($("#import_progress_div").show(),$("#import_progression_details").html(t+"/"+e),$("#import_progressbar_next").width("0%"),$("#import_progressbar_done").width(100-a+"%"),$("#import_progressbar_done2").width(a+"%"),$("#import_progressbar_done2 span").html(parseInt(a)+"%")),s&&($("#import_progressbar_done").parent().removeClass("active progress-striped"),$("#import_details_post_limit").hide(),$("#import_details_progressing").hide(),$("#import_details_finished").show(),$("#importProgress").modal({keyboard:!0,closable:!0}),$("#import_stop_button").hide(),$("#import_close_button").show())}function updateValidationError(t,e){$("#import_details_progressing").hide(),$("#import_details_finished").hide(),e?($("#import_details_warning ul").append(t),$("#import_details_warning").show()):($("#import_details_error ul").append(t),$("#import_details_error").show(),$("#validate_progressbar_next").addClass("progress-bar-danger"),$("#validate_progressbar_next").removeClass("progress-bar-info"),$("#import_stop_button").hide(),$("#import_close_button").show())}function updateValidationInfo(t){$("#import_details_progressing").hide(),$("#import_details_finished").hide(),$("#import_details_info ul").append(t),$("#import_details_info").show()}function updateProgressionError(t,e){$("#import_details_progressing").hide(),$("#import_details_finished").hide(),e?($("#import_details_warning ul").append(t),$("#import_details_warning").show()):($("#import_details_error ul").append(t),$("#import_details_error").show(),$("#import_progressbar_next").addClass("progress-bar-danger"),$("#import_progressbar_next").removeClass("progress-bar-success"),$("#import_stop_button").hide(),$("#import_close_button").show())}function emptyFormScan(){$("#products_found").fadeOut(),$('#wkinventory_panel_form_scan input[name="ean"]').val("").focus(),$(".addInventoryProduct-btn").addClass("addInventoryProduct-disabled"),$("#products_found #product_list").html(""),$("#products_found #attributes_list").html(""),$("#products_found #warehouses_list").html("")}function processGeneration(t,e){var o,s=$("#ids_suppliers").chosen().val();null!=s&&(s=$.map(s,function(t){return""===t?null:t})),null!=(o=$("#ids_manufacturers").chosen().val())&&(o=$.map(o,function(t){return""===t?null:t})),$(".ajaxstatus").removeClass("alert-danger").addClass("alert-warning"),$.ajax({type:"POST",url:url_global,data:{identifier:t,task:e,ajax:"1",tab:"AdminBarcodesgen",action:"processEanUpcGeneration",suppliers_ids:null!=s?s.join(","):"",brands_ids:null!=o?o.join(","):""},dataType:"json",success:function(t){if(void 0!==t.isAllowed&&!t.isAllowed)return $(".ajaxstatus").removeClass("alert-warning").addClass("alert-danger"),$(".ajaxstatus span").html(t.responseText),$("#barcode-panels button").removeClass("blocked"),$(".ajaxstatus i").hide(),!1;$(".ajaxstatus span").html(t.responseText),t.complete||t.hasError?($("#barcode-panels button").removeClass("blocked"),$(".ajaxstatus i").hide()):($(".ajaxstatus i").show(),setTimeout(function(){processGeneration(t.identifier,e)},500))},error:function(t,e){$("#barcode-panels button").removeClass("blocked"),$(".ajaxstatus i").hide()}})}function loadInventoryEditForm(){$(".div-location, .dialog-notice").fadeIn(500),$(".dialog-notice").setCenterPositionAbsolute()}function searchProducts(){$.ajax({type:"POST",url:url_global,async:!0,dataType:"json",beforeSend:function(){$('#wkinventory_panel_form_scan input[name="ean"]').blur(),$("#wkinventory_panel_form_scan").css("opacity",.5),$(".addInventoryProduct-btn").addClass("addInventoryProduct-disabled")},data:{ajax:!0,tab:"AdminStocktake",action:"searchProducts",product_search:$("#wkinventory_panel_form_scan #ean").val()},success:function(t){var e="",o="",s="";$("#wkinventory_panel_form_scan").css("opacity",1),t.found?($("#products_found").show(),e+='<label class="control-label col-lg-3">'+product_label+"</label>",e+='<div class="col-lg-6">',e+='<select id="id_product" name="product_id" ',e+=(t.canManageWarehouses?' class="warehouses_product"':"")+' onclick="display_product_attributes();">',e+="</div>",o+='<label class="control-label col-lg-3">'+combination_label+"</label>",o+='<div class="col-lg-6">',$.each(t.products,function(){t.canManageWarehouses&&this.depend_stocks&&this.warehouses_count>0&&(s+='<label class="control-label col-lg-3">'+warehouse_label+"</label>",s+='<div class="col-lg-6">'),e+='<option value="'+this.id_product+'">'+this.name+"</option>",o+='<select class="id_product_attribute'+(this.warehouses_count>0&&t.canManageWarehouses?" warehouses_combination":"")+'" ',o+='name="product_attribute_id" id="ipa_'+this.id_product+'" style="display:none;">';this.id_product;$.each(this.combinations,function(){var e=!1;(0!=t.default_attribute_select&&parseInt(t.default_attribute_select)==parseInt(this.id_product_attribute)||0==t.default_attribute_select&&1==this.default_on)&&(e=!0),o+="<option "+(e?'selected="selected"':"")+' value="'+this.id_product_attribute+'">'+this.attributes+"</option>"}),o+="</select>",t.canManageWarehouses&&this.depend_stocks&&this.warehouses_count>0&&(s+='<select class="product_warehouse_id" name="product_warehouse_id" id="idw_'+this.id_product+'" style="display:none;">',$.each(this.warehouses,function(){s+='<option value="'+this.id_warehouse+'">'+this.name+"</option>"}),s+="</select>")}),e+="</select>",e+="</div>",$("#products_found #product_list").html(e),$("#products_found #attributes_list").html(o),t.canManageWarehouses&&$("#products_found #warehouses_list").html(s),display_product_attributes(),t.canManageWarehouses||$("#id_product").change(),$(".addInventoryProduct-btn").removeClass("addInventoryProduct-disabled"),t.automaticAddToInventory&&1==t.count_products&&$("#wkaddInventoryProduct").trigger("click")):($("#products_found").hide(),$(".addInventoryProduct-btn").addClass("addInventoryProduct-disabled"),showErrorMessage(no_product_found)),$('#wkinventory_panel_form_scan input[name="ean"]').focus()},error:function(t,e,o){showErrorMessage(e+": "+o)}})}function display_product_attributes(){0===$("#ipa_"+$("#id_product option:selected").val()+" option").length?$("#attributes_list").hide():($("#attributes_list").show(),$(".id_product_attribute").hide(),$("#ipa_"+$("#id_product option:selected").val()).show()),0!==$("#idw_"+$("#id_product option:selected").val()+" option").length&&($("#warehouses_list").show(),$(".product_warehouse_id").hide(),$("#idw_"+$("#id_product option:selected").val()).show())}function updateSoldQuantities(){WK_INVENTORY.ajaxReq("update_orders_quantity",null,WK_INVENTORY.updateOrderQuantity)}var importCancelRequest,importContinueRequest,WK_INVENTORY,url_global=window.location.href;-1!=url_global.indexOf("#")&&(url_global=url_global.split("#")[0]),importCancelRequest=!1,importContinueRequest=!1,$(document).ready(function(){$("form.AdminStocktake").length>0&&-1==window.location.href.indexOf("addwkinventory")&&$("#messages-container").html($("form.AdminStocktake").detach()),$("#wkinventory_panel_form_scan #ean").length>0&&($("#wkinventory_panel_form_scan #ean").typeWatch({captureLength:1,highlight:!0,wait:750,callback:function(){searchProducts()}}),$(document).on("keyup","#wkinventory_panel_form_scan #ean",function(t){0==$(this).val().length&&emptyFormScan()})),$("table.wkinventory_product").length>0&&$("table.wkinventory_product").find("tr.stockUpdate").each(function(){$(this).find("input").prop("disabled","disabled")}),$(document).on("keypress","#wkinventory_panel_form_scan",function(t){if(13==t.keyCode)return $("#products_found, #inventoried_product").hide(),!1}),$(document).on("change",".warehouses_combination, .warehouses_product",function(t){t.preventDefault();var e=$(t.target);if(e.is(".warehouses_product")&&0==$("#attributes_list .warehouses_combination").length&&0==$("#warehouses_list").length)return!1;id_product=e.is(".warehouses_combination")?$("#id_product").val():$(this).val(),id_product_attribute=e.is(".warehouses_combination")?$(this).val():$("#ipa_"+id_product).length>0?$("#ipa_"+id_product).val():0,$.ajax({url:url_global,type:"POST",async:!0,dataType:"json",data:{action:"loadWarehousesCombination",tab:"AdminStocktake",ajax:!0,id_product:id_product,id_product_attribute:id_product_attribute},success:function(t){$("#warehouses_list").show(),t.warehouses.length>0?($("#products_found #warehouses_list").show().fadeIn("slow"),warehouses_html='<label class="control-label col-lg-3">'+warehouse_label+"</label>",warehouses_html+='<div class="col-lg-6">',warehouses_html+='<select class="product_warehouse_id" name="product_warehouse_id">',$.each(t.warehouses,function(){warehouses_html+='<option value="'+this.id_warehouse+'">'+this.name+"</option>"}),warehouses_html+="</select>",warehouses_html+="</div>",$("#products_found #warehouses_list").html(warehouses_html)):$("#products_found #warehouses_list").html("")},error:function(t,e,o){showErrorMessage(e+": "+o)}})}),$(document).on("change","#id_warehouse",function(t){t.preventDefault(),$.ajax({url:url_global,dataType:"json",type:"POST",data:{ajax:1,id_warehouse:$(this).val(),action:"loadLocationsByWarehouse"},beforeSend:function(){$("#warehouses_locations").css("opacity",.4)},success:function(t){if($("#warehouses_locations").css("opacity",1),$("#warehouses_locations").empty(),locations_options="",t.locations&&t.locations.length>0)for(var e=0;e<t.locations.length;e++)locations_options+='<option value="'+t.locations[e].id+'">',locations_options+=t.locations[e].name,locations_options+="</option>";$("#warehouses_locations").html(locations_options)}})}),$(document).on("click","#genCodeEmptyProducts, #genCodeForceProducts",function(t){var e=$(this),o=e.attr("id");e.hasClass("blocked")?alert(waitingMsg):$("#openmsgbox").html(generationInfo+".<br /><strong>"+continueMsg+"</strong>").dialog({resizable:!1,title:warningMsg,autoheight:!0,width:460,modal:!0,closeOnEscape:!1,buttons:[{text:"OK",click:function(){$("#barcode-panels button").addClass("blocked"),$(".ajaxstatus").show().find("span").html(loadingMsg),processGeneration(0,o),$(this).dialog("close")}},{text:cancelMsg,click:function(){$(this).dialog("close")}}]})}),$(document).on("click","#is_empty_on",function(t){$form=$(this).closest("form"),$form.find("select").not("#id_shop").each(function(){$(this).prop("disabled","disabled").find("option:selected").prop("selected",!1),$(this).find("option:eq(0)").attr("selected","selected")}),"function"==typeof $.fn.tree&&($("#categories_tree").css("opacity","0.5").css("pointer-events","none"),$(".tree-panel-heading-controls").css("opacity","0.5").css("pointer-events","none"),$("#categories_tree").tree("collapseAll"),$("#collapse-all-categories_tree").hide(),$("#expand-all-categories_tree").show()),"function"==typeof uncheckAllAssociatedCategories&&uncheckAllAssociatedCategories($("#categories_tree")),$("input[name=stock_zero]").prop("disabled","disabled"),$("#stock_zero_on").attr("checked",!1),$("#stock_zero_off").attr("checked",!0)}),$(document).on("click","#is_empty_off",function(t){$form.find("select").removeAttr("disabled"),$("input[name=stock_zero]").removeAttr("disabled"),$("#categories_tree").css("opacity","1").css("pointer-events","auto"),$(".tree-panel-heading-controls").css("opacity","1").css("pointer-events","auto")}),$(document).on("click",".div-location, .close-form-location",function(t){t.preventDefault(),$(".div-location, .dialog-notice").fadeOut(500)}),$("#import_stop_button").unbind("click").click(function(){importContinueRequest?($("#importProgress").modal("hide"),importContinueRequest=!1,window.location.href=url_global):(importCancelRequest=!0,$("#import_details_progressing").hide(),$("#import_details_finished").hide(),$("#import_details_stop").show(),$("#import_stop_button").hide(),$("#update_close_button").hide())}),$("#import_continue_button").unbind("click").click(function(){$("#import_continue_button").hide(),importContinueRequest=!1,$("#import_progress_div").show(),$("#import_details_warning ul, #import_details_info ul").html(""),$("#import_details_warning, #import_details_info").hide(),processNow(0,5,-1,!1)}),$("#update_close_button").unbind("click").click(function(){window.location.href=url_global}),$(document).on("click",".beginUpdateProcess",function(t){t.preventDefault(),beginUpdateProcess(this)})}),WK_INVENTORY=function(){"use strict";var t,e,o={};return{init:function(s){"object"==typeof s?s.hasOwnProperty("translations")?$.extend(o,s.translations):console.error("No translations defined"):console.error("Must be used with an object"),s.defaultQty,e=s.addToExistantQty,t=s.ajaxUrl,$(".real_quantity, .stock_difference").blur(function(){var t,e,o,s,a,i,r,n,d,l=$(this).attr("class");"real_quantity"==l&&(e=(t=$(this).parent().parent()).find(".stock_difference"),o=parseInt(t.find(".shop_quantity").text()),s=parseInt(t.find(".sold_quantity").text()),a=parseInt($(this).val())-(o-s),e.val(a),t.attr("class",0!=a?"success":"warning"),i={inventoryProducts:$(this).serializeArray()},WK_INVENTORY.ajaxReq("update_real_quantity",i,WK_INVENTORY.updateRealQuantity)),"stock_difference"==l&&(r=$(this).parent().parent(),a=parseInt($(this).val()),d=(o=parseInt(r.find(".shop_quantity").text()))-(s=parseInt(r.find(".sold_quantity").text()))+a,(n=r.find(".real_quantity")).val(d),r.attr("class",0!=a?"success":"warning"),i={inventoryProducts:n.serializeArray()},WK_INVENTORY.ajaxReq("update_real_quantity",i,WK_INVENTORY.updateRealQuantity))})},ajaxReq:function(e,o,s){$("#form-wkinventory_product").css("opacity",.5),$.ajax({dataType:"json",type:"POST",url:t+"&ajax&action="+e,data:o,success:function(t){"function"==typeof s&&s(t),$("#form-wkinventory_product").css("opacity",1)},error:function(t,e,o){showErrorMessage(e+": "+o)}})},formUpdate:function(t){var s,a,i;if(t.preventDefault(),s=$.param($.map($(this).serializeArray(),function(t,e){return"product_attribute_id"==t.name?null:t})),$("#ipa_"+$("#id_product").val()).length>0&&$("#attributes_list").is(":visible")&&(s+="&product_attribute_id="+$("#ipa_"+$("#id_product").val()+" option:selected").val()),(a=$('[name="quantity"]')).length&&(i=parseInt(a.val()),isNaN(i)))return a.focus(),showErrorMessage(o.invalidQtyMsg),!1;WK_INVENTORY.ajaxReq("add_inventory_product",s,function(t){var o,s,a,r;return $("#inventoried_product").hide("fast"),t.success?void 0!==t.refresh_page&&t.refresh_page?(location.reload(!0),!1):((o=$("[name=real_quantity_"+t.inventoryProduct.id+"]")).length>0&&((s=o.parent().parent()).find(".real_quantity").val(t.inventoryProduct.real_quantity),e?(a=s.find("td.stock_difference input").length>0?"td.stock_difference input":"td .stock_difference",s.find(".stock_difference").val(parseInt(s.find(a).val())+i)):s.find(".stock_difference").val(i),s.attr("class","success")),r='<div class="alert alert-success"><button class="close" data-dismiss="alert" type="button">x</button>',r+=t.message+" :<br />",r+='<table class="table">',r+="<thead>",r+="<tr>",r+='<td class="text-center"><strong>'+availableQtyTxt+"</strong></td>",r+='<td class="text-center"><strong>'+soldQtyTxt+"</strong></td>",r+='<td class="text-center"><strong>'+adjustmentQtyTxt+"</strong></td>",r+='<td class="text-center"><strong>'+realQtyTxt+"</strong></td>",r+="</tr>",r+="</thead>",r+="<tbody>",r+='<tr><td class="text-center">'+t.inventoryProduct.shop_quantity+"</td>",r+='<td class="text-center">'+t.inventoryProduct.sold_quantity+"</td>",r+='<td class="text-center">'+t.inventoryProduct.stock_difference+"</td>",r+='<td class="text-center">'+t.inventoryProduct.real_quantity+"</td></tr>",r+="</tbody>",r+="</table></div>",emptyFormScan(),$("#inventoried_product").html(r).fadeIn(),void setTimeout(function(){$("#inventoried_product").fadeOut()},5e3)):(showErrorMessage(t.message),!1)})},scrollToTarget:function(t,e){if(void 0!==t){var o=t.offset().top;void 0!==o&&$("body,html").animate({scrollTop:o-e},800)}},updateRealQuantity:function(t){t.success&&showSuccessMessage(o.upToDate)},autoFill:function(){var t=parseInt($('#wkinventory_panel_form_scan input[name="quantity"]').val());isNaN(t)?showErrorMessage(o.invalidQtyMsg):$("#openmsgbox").html(o.autofillAlert+'<span class="red">'+t+"</span><strong>"+o.continueMsg+"</strong>").dialog({resizable:!1,title:o.warningMsg,autoheight:!0,width:460,modal:!0,closeOnEscape:!1,buttons:[{text:"OK",click:function(){$(".wkinventory_product > tbody tr").each(function(){var o=$(this).find(".real_quantity"),s=$(this).find(".stock_difference"),a=parseInt($(this).find(".shop_quantity").text()),i=parseInt($(this).find(".sold_quantity").text());e?(s.val(parseInt($(this).find("td.stock_difference input").val())+t),o.val(parseInt(o.val())+t)):(s.val(t),o.val(a-i+t))});var o={inventoryProducts:$(".real_quantity").serializeArray()};WK_INVENTORY.ajaxReq("update_real_quantity",o,WK_INVENTORY.updateRealQuantity),$(this).dialog("close")}},{text:o.cancelTxt,click:function(){$(this).dialog("close")}}]})},updateOrderQuantity:function(t,e){if(void 0===e&&(e=!0),!t.hasOwnProperty("WKInventoryProducts")||!t.WKInventoryProducts.length)return e&&showErrorMessage(t.message),!1;t.success&&e&&showSuccessMessage(t.message),t.WKInventoryProducts.forEach(function(t){var e=$("[name=real_quantity_"+t.id+"]").parent().parent();$.each(t,function(t,o){"id"!==t&&("real_quantity"===t?e.find("."+t).val(o):e.find("."+t).text(o))})})}}}(),void 0===$.fn.setCenterPositionAbsolute&&($.fn.setCenterPositionAbsolute=function(){var t=20,e=$(document).scrollTop(),o=$(this).width(),s=$(window).width();$(this).css({top:$(this).height()>$(window).height()?e+t:e+($(window).height()-$(this).height())/20,left:(s-o)/3})});
